-- This file and its contents are licensed under the Timescale License.
-- Please see the included NOTICE for copyright information and
-- LICENSE-TIMESCALE for a copy of the license.
\set ON_ERROR_STOP 0
--DDL commands on continuous aggregates
CREATE TABLE conditions (
      timec        TIMESTAMPTZ       NOT NULL,
      location    TEXT              NOT NULL,
      temperature integer  NULL,
      humidity    DOUBLE PRECISION  NULL,
      timemeasure TIMESTAMPTZ,
      timeinterval INTERVAL
);
select table_name from create_hypertable('conditions', 'timec');
 table_name 
------------
 conditions
(1 row)

-- check that GRANTS work correctly
\c :TEST_DBNAME :ROLE_SUPERUSER
create  view mat_m1 WITH ( timescaledb.continuous)
AS
Select sum( temperature ), min(location)
from conditions
group by time_bucket('1week', timec);
NOTICE:  adding not-null constraint to column "time_partition_col"
GRANT select on mat_m1 to :ROLE_DEFAULT_PERM_USER;
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER_2
select count(*) from mat_m1;
ERROR:  permission denied for relation mat_m1
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
select count(*) from mat_m1;
 count 
-------
     0
(1 row)

\set ON_ERROR_STOP 1
\c :TEST_DBNAME :ROLE_SUPERUSER
CREATE SCHEMA rename_schema;
GRANT ALL ON SCHEMA rename_schema TO :ROLE_DEFAULT_PERM_USER;
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
CREATE TABLE foo(time TIMESTAMPTZ, data INTEGER);
SELECT create_hypertable('foo', 'time');
NOTICE:  adding not-null constraint to column "time"
 create_hypertable 
-------------------
 (3,public,foo,t)
(1 row)

CREATE VIEW rename_test WITH ( timescaledb.continuous)
AS SELECT time_bucket('1week', time), COUNT(data)
    FROM foo
    GROUP BY 1;
NOTICE:  adding not-null constraint to column "time_partition_col"
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 public           | rename_test    | _timescaledb_internal | ts_internal_rename_testview
(2 rows)

ALTER VIEW rename_test SET SCHEMA rename_schema;
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 rename_schema    | rename_test    | _timescaledb_internal | ts_internal_rename_testview
(2 rows)

\c :TEST_DBNAME :ROLE_SUPERUSER
ALTER VIEW _timescaledb_internal.ts_internal_rename_testview SET SCHEMA public;
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 rename_schema    | rename_test    | public                | ts_internal_rename_testview
(2 rows)

\c :TEST_DBNAME :ROLE_SUPERUSER
ALTER SCHEMA rename_schema RENAME TO new_name_schema;
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 new_name_schema  | rename_test    | public                | ts_internal_rename_testview
(2 rows)

ALTER VIEW ts_internal_rename_testview SET SCHEMA new_name_schema;
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 new_name_schema  | rename_test    | new_name_schema       | ts_internal_rename_testview
(2 rows)

\c :TEST_DBNAME :ROLE_SUPERUSER
ALTER SCHEMA new_name_schema RENAME TO foo_name_schema;
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 foo_name_schema  | rename_test    | foo_name_schema       | ts_internal_rename_testview
(2 rows)

ALTER VIEW foo_name_schema.rename_test SET SCHEMA public;
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 public           | rename_test    | foo_name_schema       | ts_internal_rename_testview
(2 rows)

\c :TEST_DBNAME :ROLE_SUPERUSER
ALTER SCHEMA foo_name_schema RENAME TO rename_schema;
\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema | user_view_name |  partial_view_schema  |      partial_view_name      
------------------+----------------+-----------------------+-----------------------------
 public           | mat_m1         | _timescaledb_internal | ts_internal_mat_m1view
 public           | rename_test    | rename_schema         | ts_internal_rename_testview
(2 rows)

ALTER VIEW rename_test RENAME TO rename_c_aggregate;
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema |   user_view_name   |  partial_view_schema  |      partial_view_name      
------------------+--------------------+-----------------------+-----------------------------
 public           | mat_m1             | _timescaledb_internal | ts_internal_mat_m1view
 public           | rename_c_aggregate | rename_schema         | ts_internal_rename_testview
(2 rows)

SELECT * FROM rename_c_aggregate;
 time_bucket | count 
-------------+-------
(0 rows)

ALTER VIEW rename_schema.ts_internal_rename_testview RENAME TO partial_view;
SELECT user_view_schema, user_view_name, partial_view_schema, partial_view_name
      FROM _timescaledb_catalog.continuous_agg;
 user_view_schema |   user_view_name   |  partial_view_schema  |   partial_view_name    
------------------+--------------------+-----------------------+------------------------
 public           | mat_m1             | _timescaledb_internal | ts_internal_mat_m1view
 public           | rename_c_aggregate | rename_schema         | partial_view
(2 rows)

